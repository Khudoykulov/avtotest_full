{% extends 'base.html' %}

{% block title %}{{ content.title }} - Ta'lim - Avtotest{% endblock %}

{% block content %}
<div class="card">
    <div class="mb-3">
        <a href="{% url 'education:category' content.category.id %}" class="btn btn-secondary">
            ‚¨Ö {{ content.category.name_uz }}ga qaytish
        </a>
    </div>
    
    <h1>{{ content.title }}</h1>
    
    <!-- DEBUG INFO -->
    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #ffeaa7;">
        <h4>üîç Debug Ma'lumotlari:</h4>
        <p><strong>Content Type:</strong> {{ content.content_type }}</p>
        <p><strong>Video URL:</strong> {{ content.video_url }}</p>
        <p><strong>Video URL mavjudmi:</strong> {% if content.video_url %}Ha{% else %}Yo'q{% endif %}</p>
    </div>
    
    {% if content.content_type == 'video' and content.video_url %}
        {% load video_filters %}
        
        <!-- VIDEO SECTION -->
        <div style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin: 2rem 0;">
            <h3>üé• Video Dars</h3>
            
            {% if content.video_url|is_youtube %}
                <div style="background: white; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                    <h4>YouTube Video</h4>
                    <p><strong>Video ID:</strong> {{ content.video_url|youtube_video_id }}</p>
                    
                    <!-- YouTube iframe -->
                    <div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; margin: 1rem 0; background: #000; border-radius: 8px; overflow: hidden;">
                        <iframe 
                            src="{{ content.video_url|youtube_embed_url }}"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            title="{{ content.title }}">
                        </iframe>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="{{ content.video_url }}" target="_blank" class="btn btn-primary">
                            üì∫ YouTube da ochish
                        </a>
                    </div>
                </div>
            {% else %}
                <video controls style="width: 100%; max-height: 400px; border-radius: 8px;">
                    <source src="{{ content.video_url }}" type="video/mp4">
                    Video yuklanmadi
                </video>
            {% endif %}
        </div>
    {% endif %}
        
        {% if content.video_url|is_youtube %}
            <!-- YouTube Video -->
            <div class="youtube-video-container" style="margin: 2rem 0;">
                <!-- Thumbnail bilan fallback -->
                <div id="youtube-{{ content.video_url|youtube_video_id }}" class="youtube-placeholder" 
                     style="position: relative; width: 100%; padding-bottom: 56.25%; background: #000; border-radius: 12px; overflow: hidden; cursor: pointer; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                    
                    <!-- YouTube thumbnail -->
                    <img src="{{ content.video_url|youtube_thumbnail_url }}" 
                         alt="{{ content.title }}"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    
                    <!-- Fallback agar thumbnail yuklanmasa -->
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); display: none; align-items: center; justify-content: center; color: white; text-align: center;">
                        <div>
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üì∫</div>
                            <h3>{{ content.title }}</h3>
                            <p>YouTube Video</p>
                        </div>
                    </div>
                    
                    <!-- Play button -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; background: rgba(255,0,0,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="width: 0; height: 0; border-left: 25px solid white; border-top: 15px solid transparent; border-bottom: 15px solid transparent; margin-left: 5px;"></div>
                    </div>
                    
                    <!-- Video ma'lumotlari -->
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 2rem 1.5rem 1.5rem; color: white;">
                        <h4 style="margin: 0 0 0.5rem 0;">{{ content.title }}</h4>
                        <small style="opacity: 0.8;">üé• YouTube Video ‚Ä¢ Bosib ko'ring</small>
                    </div>
                </div>
                
                <!-- YouTube iframe (yashirin) -->
                <div id="iframe-{{ content.video_url|youtube_video_id }}" style="display: none; position: relative; width: 100%; padding-bottom: 56.25%; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                    <iframe src="{{ content.video_url|youtube_embed_url }}" 
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            title="{{ content.title }}"></iframe>
                </div>
                
                <!-- JavaScript -->
                <script>
                document.getElementById('youtube-{{ content.video_url|youtube_video_id }}').addEventListener('click', function() {
                    this.style.display = 'none';
                    document.getElementById('iframe-{{ content.video_url|youtube_video_id }}').style.display = 'block';
                });
                </script>
                
                <!-- Alternative link -->
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="{{ content.video_url }}" target="_blank" class="btn btn-primary">
                        üì∫ YouTube da ochish
                    </a>
                </div>
            </div>
        {% else %}
            <!-- Generic video player -->
            <div class="video-container">
                <video controls style="width: 100%; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                    <source src="{{ content.video_url }}" type="video/mp4">
                    <source src="{{ content.video_url }}" type="video/webm">
                    <source src="{{ content.video_url }}" type="video/ogg">
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <p>Sizning brauzeringiz video ni qo'llab-quvvatlamaydi.</p>
                        <a href="{{ content.video_url }}" target="_blank" class="btn btn-primary">
                            Video ni yangi oynada ochish
                        </a>
                    </div>
                </video>
            </div>
        {% endif %}
        
    {% endif %}
    
    {% if content.content_type == 'image' and content.image %}
        <div class="text-center mb-3">
            {% load static %}
            <img src="{{ content.image.url }}" 
                 alt="{{ content.title }}" 
                 class="content-image">
        </div>
    {% endif %}
    
    {% if content.text_content %}
        <div class="content-text">
            {{ content.text_content|linebreaks }}
        </div>
    {% endif %}
    
    <div class="mt-4">
        <a href="{% url 'quiz:take_category_test' content.category.id %}" class="btn btn-primary">
            Test topshirish
        </a>
    </div>
</div>

{% if related_content %}
<div class="card">
    <h3>Shunga o'xshash materiallar</h3>
    <div class="row">
        {% for item in related_content %}
        <div class="col-md-4">
            <div class="card">
                <h5>{{ item.title }}</h5>
                {% if item.content_type == 'text' and item.text_content %}
                    <p>{{ item.text_content|truncatewords:15 }}</p>
                {% endif %}
                <a href="{% url 'education:content' item.id %}" class="btn btn-sm btn-outline-primary">
                    Ko'rish
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<style>
.video-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    margin: 2rem 0;
}

.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
}

.content-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.content-text {
    font-size: 1.1rem;
    line-height: 1.7;
    color: #333;
}

.btn-outline-primary {
    color: #667eea;
    border-color: #667eea;
    background: transparent;
}

.btn-outline-primary:hover {
    background: #667eea;
    color: white;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}
</style>
{% endblock %}