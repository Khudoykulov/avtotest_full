{% extends 'base.html' %}

{% block title %}{{ test_name }} - Test topshirish{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div class="card">
        <!-- Test Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
            <button onclick="window.history.back()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                ‚Üê Testni tugatish
            </button>
            <h1 style="color: #667eea; margin: 0;">{{ test_name }}</h1>
            <div></div>
        </div>

        <!-- Test Stats -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-bottom: 2rem;">
            <div style="text-align: center; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem;">JORIY SAVOL</div>
                <div id="current-question" style="font-size: 1.5rem; font-weight: bold; color: #333;">1/{{ questions.count }}</div>
            </div>
            <div style="text-align: center; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem;">NATIJA</div>
                <div id="correct-count" style="font-size: 1.5rem; font-weight: bold; color: #6c757d;">?</div>
            </div>
            <div style="text-align: center; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem;">QOLGAN VAQT</div>
                <div id="timer" style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">20:00</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
            <!-- Question Area -->
            <div>
                <div id="question-container">
                    <!-- Questions will be loaded here by JavaScript -->
                </div>
                
                <!-- Navigation Buttons -->
                <div style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e9ecef;">
                    <button id="prev-btn" onclick="previousQuestion()" 
                            style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚Üê Oldingi savol
                    </button>
                    <button id="next-btn" onclick="nextQuestion()" 
                            style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        Keyingi savol ‚Üí
                    </button>
                </div>
            </div>

            <!-- Question Navigation -->
            <div>
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                    <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                        <div style="font-size: 1.2rem; margin-right: 0.5rem;">üìã</div>
                        <h3 style="color: #333; margin: 0;">Savollar ro'yxati</h3>
                    </div>
                    
                    <div id="question-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                        {% for i in "12345678901234567890" %}
                        <button class="question-nav-btn" data-question="{{ forloop.counter }}" 
                                style="width: 40px; height: 40px; border: 2px solid #dee2e6; background: white; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                            {{ forloop.counter }}
                        </button>
                        {% endfor %}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; color: #1976d2; margin-bottom: 0.5rem;">PROGRESS</div>
                            <div id="progress-bar" style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="progress-fill" style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                                <span id="answered-count">0</span>/<span id="total-questions">{{ questions|length }}</span> javob berildi
                            </div>
                        </div>
                    </div>

                    <button onclick="finishTest()" class="btn" style="width: 100%; background: #28a745;">
                        ‚úì Testni yakunlash
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real Questions Data from Backend -->
<script>
const questions = [
    {% for question in questions %}
    {
        id: {{ question.id }},
        text: "{{ question.question_text|escapejs }}",
        image: {% if question.image %}"{{ question.image.url }}"{% else %}null{% endif %},
        answers: [
            {% for answer in question.answers.all %}
            {
                id: {{ answer.id }},
                text: "{{ answer.answer_text|escapejs }}",
                correct: {{ answer.is_correct|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let currentQuestionIndex = 0;
let userAnswers = {};
let timeLeft = 1200; // 20 minutes in seconds
let timerInterval;

// Initialize test
document.addEventListener('DOMContentLoaded', function() {
    loadQuestion(0);
    startTimer();
    updateQuestionNavigation();
    updateNavigationButtons();
});

function loadQuestion(index) {
    const question = questions[index] || questions[0];
    currentQuestionIndex = index;
    
    const container = document.getElementById('question-container');
    container.innerHTML = `
        <div style="margin-bottom: 2rem;">
            ${question.image ? `<img src="${question.image}" alt="Test rasmi" style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">` : ''}
            <div style="background: #e3f2fd; padding: 1.5rem; border-left: 4px solid #2196f3; border-radius: 8px; margin-bottom: 1.5rem;">
                <p style="font-size: 1.1rem; line-height: 1.6; margin: 0; color: #333;">${question.text}</p>
            </div>
        </div>
        
        <div style="space-y: 1rem;">
            ${question.answers.map(answer => `
                <label style="display: block; background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s;" 
                       onmouseover="this.style.borderColor='#667eea'" 
                       onmouseout="this.style.borderColor='#e9ecef'"
                       onclick="selectAnswer(${question.id}, ${answer.id}, this)">
                    <input type="radio" name="question_${question.id}" value="${answer.id}" style="margin-right: 0.75rem;">
                    <span style="font-size: 1rem; line-height: 1.5;">${answer.text}</span>
                </label>
            `).join('')}
        </div>
    `;
    
    // Update current question display
    document.getElementById('current-question').textContent = `${index + 1}/${questions.length}`;
    
    // Restore previous answer if exists - but only show selection, not results
    if (userAnswers[question.id]) {
        const selectedAnswerId = userAnswers[question.id];
        
        // Only show which answer was selected, not the results
        const labels = container.querySelectorAll('label');
        labels.forEach(label => {
            const input = label.querySelector('input');
            
            if (input.value == selectedAnswerId) {
                // Highlight selected answer
                label.style.borderColor = '#667eea';
                label.style.background = '#e3f2fd';
                label.style.fontWeight = 'bold';
                input.checked = true;
            } else {
                // Keep other answers normal
                label.style.borderColor = '#e9ecef';
                label.style.background = 'white';
                label.style.fontWeight = 'normal';
            }
        });
    }
}

function selectAnswer(questionId, answerId, element) {
    userAnswers[questionId] = answerId;
    
    // Just mark the selected answer - no feedback yet
    const input = element.querySelector('input');
    input.checked = true;
    
    // Update selected answer styling (just highlight selection)
    const labels = element.parentNode.querySelectorAll('label');
    labels.forEach(label => {
        const labelInput = label.querySelector('input');
        if (labelInput.value == answerId) {
            // Highlight selected answer
            label.style.borderColor = '#667eea';
            label.style.background = '#e3f2fd';
            label.style.fontWeight = 'bold';
        } else {
            // Reset other answers
            label.style.borderColor = '#e9ecef';
            label.style.background = 'white';
            label.style.fontWeight = 'normal';
        }
    });
    
    // Update question navigation button to show it's answered (but not result)
    const navBtn = document.querySelector(`[data-question="${currentQuestionIndex + 1}"]`);
    navBtn.style.background = '#667eea';  // Blue for answered
    navBtn.style.color = 'white';
    navBtn.style.borderColor = '#667eea';
    navBtn.innerHTML = `${currentQuestionIndex + 1} ‚úì`;
    
    // Update progress
    updateProgress();
}

function showQuestionResult(questionIndex) {
    const question = questions[questionIndex];
    if (!question || !userAnswers[question.id]) {
        return; // No answer to show result for
    }
    
    const selectedAnswerId = userAnswers[question.id];
    const selectedAnswer = question.answers.find(a => a.id == selectedAnswerId);
    const isCorrect = selectedAnswer && selectedAnswer.correct;
    
    // Update navigation button with result
    const navBtn = document.querySelector(`[data-question="${questionIndex + 1}"]`);
    if (isCorrect) {
        navBtn.style.background = '#28a745';  // Green for correct
        navBtn.innerHTML = `${questionIndex + 1} ‚úÖ`;
        navBtn.style.borderColor = '#28a745';
    } else {
        navBtn.style.background = '#dc3545';  // Red for incorrect  
        navBtn.innerHTML = `${questionIndex + 1} ‚ùå`;
        navBtn.style.borderColor = '#dc3545';
    }
    navBtn.style.color = 'white';
    
    // Update correct count
    updateRealCorrectCount();
}

function updateRealCorrectCount() {
    // Calculate correct answers from navigation buttons that show results
    let correctCount = 0;
    const buttons = document.querySelectorAll('.question-nav-btn');
    buttons.forEach((btn) => {
        if (btn.innerHTML.includes('‚úÖ')) {
            correctCount++;
        }
    });
    
    // Only show count if there are any results shown
    if (correctCount > 0 || document.querySelector('.question-nav-btn[style*="dc3545"]')) {
        document.getElementById('correct-count').textContent = correctCount;
        document.getElementById('correct-count').style.color = '#28a745';
    }
}

function nextQuestion() {
    // Show result for current question before moving
    showQuestionResult(currentQuestionIndex);
    
    if (currentQuestionIndex < questions.length - 1) {
        loadQuestion(currentQuestionIndex + 1);
        updateQuestionNavigation();
        updateNavigationButtons();
    } else {
        // All questions answered, show finish button prominently
        const finishBtn = document.querySelector('button[onclick="finishTest()"]');
        finishBtn.style.animation = 'pulse 2s infinite';
        finishBtn.style.background = '#dc3545';
        finishBtn.innerHTML = 'üéØ Testni YAKUNLASH!';
    }
}

function previousQuestion() {
    // Show result for current question before moving
    showQuestionResult(currentQuestionIndex);
    
    if (currentQuestionIndex > 0) {
        loadQuestion(currentQuestionIndex - 1);
        updateQuestionNavigation();
        updateNavigationButtons();
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    // Update previous button
    if (currentQuestionIndex === 0) {
        prevBtn.style.opacity = '0.5';
        prevBtn.style.cursor = 'not-allowed';
        prevBtn.disabled = true;
    } else {
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
        prevBtn.disabled = false;
    }
    
    // Update next button
    if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.opacity = '0.5';
        nextBtn.style.cursor = 'not-allowed';
        nextBtn.disabled = true;
    } else {
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
        nextBtn.disabled = false;
    }
}

function updateQuestionNavigation() {
    const buttons = document.querySelectorAll('.question-nav-btn');
    buttons.forEach((btn, index) => {
        // Only process first 20 buttons and existing questions
        if (index < 20) {
            const question = questions[index];
            
            if (!question) {
                // No question for this slot
                btn.onclick = null;
                btn.style.background = '#f8f9fa';
                btn.style.color = '#6c757d';
                btn.style.borderColor = '#e9ecef';
                btn.style.transform = 'scale(1)';
                btn.style.cursor = 'not-allowed';
                btn.innerHTML = `${index + 1}`;
                return;
            }
            
            const isAnswered = userAnswers[question.id];
            
            // Only allow clicking on current question or answered questions
            if (index === currentQuestionIndex) {
                btn.onclick = null; // Current question - no need to click
                btn.style.background = '#dc3545';
                btn.style.color = 'white';
                btn.style.borderColor = '#dc3545';
                btn.style.transform = 'scale(1.1)';
                btn.style.cursor = 'default';
                btn.innerHTML = `${index + 1}`;
            } else if (isAnswered) {
                // Answered questions - allow clicking to review
                btn.onclick = () => {
                    // Show result for current question before moving
                    showQuestionResult(currentQuestionIndex);
                    loadQuestion(index);
                    updateQuestionNavigation();
                    updateNavigationButtons();
                };
                
                // Check if result has been shown for this question
                if (btn.innerHTML.includes('‚úÖ')) {
                    // Keep green for correct
                    btn.style.background = '#28a745';
                    btn.style.borderColor = '#28a745';
                    btn.innerHTML = `${index + 1} ‚úÖ`;
                } else if (btn.innerHTML.includes('‚ùå')) {
                    // Keep red for incorrect
                    btn.style.background = '#dc3545';
                    btn.style.borderColor = '#dc3545';
                    btn.innerHTML = `${index + 1} ‚ùå`;
                } else {
                    // Blue for answered but result not shown yet
                    btn.style.background = '#667eea';
                    btn.style.borderColor = '#667eea';
                    btn.innerHTML = `${index + 1} ‚úì`;
                }
                btn.style.color = 'white';
                btn.style.transform = 'scale(1)';
                btn.style.cursor = 'pointer';
            } else if (index < currentQuestionIndex) {
                // Previous unanswered questions - locked
                btn.onclick = null;
                btn.style.background = '#6c757d';
                btn.style.color = 'white';
                btn.style.borderColor = '#6c757d';
                btn.style.transform = 'scale(1)';
                btn.style.cursor = 'not-allowed';
                btn.innerHTML = `${index + 1} üîí`;
            } else {
                // Future questions - disabled
                btn.onclick = null;
                btn.style.background = '#e9ecef';
                btn.style.color = '#6c757d';
                btn.style.borderColor = '#dee2e6';
                btn.style.transform = 'scale(1)';
                btn.style.cursor = 'not-allowed';
                btn.innerHTML = `${index + 1}`;
            }
        }
    });
}

function updateCorrectCount() {
    // Don't show correct count during test - only show answered count
    const answeredCount = Object.keys(userAnswers).length;
    document.getElementById('correct-count').textContent = '?';
    
    // Update progress
    updateProgress();
}

function updateProgress() {
    const answeredCount = Object.keys(userAnswers).length;
    const totalQuestions = questions.length;
    const progressPercentage = (answeredCount / totalQuestions) * 100;
    
    // Update progress bar
    document.getElementById('progress-fill').style.width = `${progressPercentage}%`;
    
    // Update answered count text
    document.getElementById('answered-count').textContent = answeredCount;
}

function startTimer() {
    timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            finishTest();
        }
    }, 1000);
}

function finishTest() {
    clearInterval(timerInterval);
    
    const answeredCount = Object.keys(userAnswers).length;
    if (answeredCount < questions.length) {
        if (!confirm(`Siz ${answeredCount}/${questions.length} ta savolga javob berdingiz. Testni yakunlashni xohlaysizmi?`)) {
            return;
        }
    }
    
    // Show loading
    const container = document.getElementById('question-container');
    container.innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
            <h2>Test natijasi hisoblanmoqda...</h2>
            <div style="margin-top: 2rem;">
                <div style="width: 200px; height: 4px; background: #e9ecef; margin: 0 auto; border-radius: 2px; overflow: hidden;">
                    <div style="width: 0%; height: 100%; background: #28a745; transition: width 2s;" id="progress-bar"></div>
                </div>
            </div>
        </div>
    `;
    
    // Animate progress bar
    setTimeout(() => {
        document.getElementById('progress-bar').style.width = '100%';
    }, 100);
    
    // Calculate results after delay for better UX
    setTimeout(() => {
        let correctCount = 0;
        let incorrectAnswers = [];
        
        // Check all answers
        Object.entries(userAnswers).forEach(([questionId, answerId]) => {
            const question = questions.find(q => q.id == questionId);
            if (question) {
                const answer = question.answers.find(a => a.id == answerId);
                if (answer && answer.correct) {
                    correctCount++;
                } else {
                    incorrectAnswers.push({
                        question: question.text,
                        selectedAnswer: answer ? answer.text : 'Tanlanmagan',
                        correctAnswer: question.answers.find(a => a.correct).text
                    });
                }
            }
        });
        
        // Update correct count display
        document.getElementById('correct-count').textContent = correctCount;
        
        // Calculate percentage
        const percentage = Math.round((correctCount / questions.length) * 100);
        const passed = percentage >= 70;
        
        // Show detailed results
        showTestResults(correctCount, percentage, passed, incorrectAnswers);
        
    }, 2000);
}

function showTestResults(correctCount, percentage, passed, incorrectAnswers) {
    const container = document.getElementById('question-container');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">
                ${passed ? 'üéâ' : 'üòû'}
            </div>
            
            <h1 style="color: ${passed ? '#28a745' : '#dc3545'}; margin-bottom: 1rem;">
                ${passed ? 'TABRIKLAYMIZ!' : 'AFSUSKI...'}
            </h1>
            
            <div style="background: ${passed ? '#d4edda' : '#f8d7da'}; 
                        border: 2px solid ${passed ? '#28a745' : '#dc3545'}; 
                        border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="margin: 0; color: ${passed ? '#155724' : '#721c24'};">
                    ${passed ? 'Siz testdan muvaffaqiyatli o\'tdingiz!' : 'Test topshirilmadi'}
                </h2>
                <div style="font-size: 2rem; margin: 1rem 0; font-weight: bold;">
                    ${correctCount}/${questions.length} (${percentage}%)
                </div>
                <p style="margin: 0; color: ${passed ? '#155724' : '#721c24'};">
                    ${passed ? 'O\'tish uchun zarur: 70%' : 'Qayta urinib ko\'ring. O\'tish uchun zarur: 70%'}
                </p>
            </div>
            
            ${incorrectAnswers.length > 0 ? `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; text-align: left;">
                    <h3 style="color: #856404; margin-bottom: 1rem; text-align: center;">‚ö†Ô∏è Xato javoblar:</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${incorrectAnswers.slice(0, 5).map((item, index) => `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                                <strong>Savol ${index + 1}:</strong> ${item.question.substring(0, 100)}...
                                <br><span style="color: #dc3545;">‚ùå Sizning javobingiz:</span> ${item.selectedAnswer}
                                <br><span style="color: #28a745;">‚úÖ To'g'ri javob:</span> ${item.correctAnswer}
                            </div>
                        `).join('')}
                        ${incorrectAnswers.length > 5 ? `<p style="text-align: center; color: #856404;">va yana ${incorrectAnswers.length - 5} ta xato...</p>` : ''}
                    </div>
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="window.location.href='{% url 'quiz:statistics' %}'" 
                        class="btn" style="background: #17a2b8; color: white; padding: 1rem 2rem;">
                    üìä Statistikani ko'rish
                </button>
                <button onclick="window.location.href='{% url 'home' %}'" 
                        class="btn" style="background: #6c757d; color: white; padding: 1rem 2rem;">
                    üè† Bosh sahifa
                </button>
                <button onclick="location.reload()" 
                        class="btn" style="background: #28a745; color: white; padding: 1rem 2rem;">
                    üîÑ Qayta urinish
                </button>
            </div>
        </div>
    `;
    
    // Submit test results to backend
    submitTestResults(correctCount, percentage, passed);
}

function submitTestResults(correctCount, percentage, passed) {
    const testData = {
        answers: userAnswers,
        score: correctCount,
        total_questions: questions.length,
        time_taken: 1200 - timeLeft,
        test_type: '{{ test_type }}',
        {% if ticket_id %}ticket_id: {{ ticket_id }},{% endif %}
        {% if category_id %}category_id: {{ category_id }},{% endif %}
        {% if variant_id %}variant_id: {{ variant_id }},{% endif %}
        csrfmiddlewaretoken: '{{ csrf_token }}'
    };
    
    fetch('{% url "quiz:submit_test" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.result_id) {
            // Optionally redirect to detailed results page
            // window.location.href = `/quiz/results/${data.result_id}/`;
        }
    })
    .catch(error => {
        console.error('Error submitting test:', error);
    });
}
</script>

<style>
.question-nav-btn {
    transition: all 0.3s ease !important;
}

.question-nav-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.question-nav-btn.current {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.question-nav-btn.answered {
    animation: none;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
}

label:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.test-progress {
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    height: 6px;
    border-radius: 3px;
    transition: width 0.3s ease;
}

@media (max-width: 768px) {
    .card > div:first-child {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
    
    #question-grid {
        grid-template-columns: repeat(5, 1fr) !important;
    }
    
    .btn {
        font-size: 0.9rem !important;
        padding: 0.7rem 1.5rem !important;
    }
}
</style>
{% endblock %}
